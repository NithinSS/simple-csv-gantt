<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gantt Chart</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { padding: 0; margin: 0; position: relative; font-family: Arial, Helvetica, sans-serif; }
    .title { display: grid; grid-template-columns: 5fr auto auto; gap: 20px; margin: 15px; align-items: center; justify-items: start; }
    .header { border: none; font-size: 1.5em; font-family: 'Times New Roman', Times, serif; font-style: italic; font-weight: 600; }
    .file-select-group { font-size: 14px; }
    .btn { cursor: pointer; padding: 5px 12px; text-align: center; border-radius: 5px; font-size: 15px; user-select: none; margin: 8px; }
    .btn--primary { background: #4a6fa5; color: white; border: none; }
    .btn--secondary { background: white; color: black; }
    .btn:hover { scale: 102%; }
    .choose-file-btn { background-color: white; border: 1px solid #ddd; display: flex; align-items: center; gap: 8px; }
    .file-name-display { font-weight: normal; background-color: transparent; padding: 0; border-radius: 0; color: #666; }
    #csvSection { position: fixed; bottom: 0; display: flex; flex-direction: column-reverse; align-items: self-start; overflow-y: auto; max-height: 70%; }
    details#csvSection > summary::before { content: 'Show CSV'; }
    details#csvSection[open] > summary::before { content: 'Hide CSV'; }
    details#csvSection[open] { background-color: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .show-csv { position: sticky; bottom: 8px; box-shadow: 0 -2px 8px rgba(0,0,0,0.3); }
    #tbl { margin: 10px; font-size: 14px; }
    #tbl th { background: #f5f5f5; padding: 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; position: sticky; top: 0; }
    #tbl td { padding: 4px; }
    #tbl input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; }
    #tbl button { background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 3px; }
    #tbl td:nth-child(6) input, /* Duration */
    #tbl td:nth-child(7) input { /* Percent */
        width: 50px;
    }
    #chart { margin: 0 5px; }
  </style>
</head>
<body>
  <div class="title">
    <input class="header" type="text" value="Just Simple Gantt">

    <input type="file" id="import" accept=".csv" class="control" style="display: none;">
    <div class="file-select-group control">
      <label for="import" class="btn choose-file-btn" style="display: inline-block;">
        Choose File
        <span class="file-name-display">No file chosen</span>
      </label>
    </div>
      
    <button class="export-btn control btn btn--primary" onclick="exp()">Export CSV</button>
  </div>
  <div id="chart" style="max-height:600px"></div>
  <details id="csvSection" class="data control">
    <table id="tbl">
      <tr><th>ID<th>Name<th>Category<th>Start<th>End<th>Duration<th>%<th>Deps<th>
    </table>
    <button class="btn btn--secondary add-btn" onclick="add()">+ Add row</button>
    <summary class="btn btn--primary show-csv">
    </summary>
  </details>

  <script>
    let chart, ready = false;
    
    window.onload = () => {
      google.charts.load('current', {packages: ['gantt']});
      google.charts.setOnLoadCallback(() => {
        chart = new google.visualization.Gantt(document.getElementById('chart'));
        ready = true;
        const sample = [
          {id: 'Research', name: 'Find sources', resource: 'research', start: '2025-01-01', end: '2025-01-05', percent: '100'},
          {id: 'Outline', name: 'Outline paper', start: '2025-01-06', end: '2025-01-08', percent: '100'},
          {id: 'Write', name: 'Write draft', resource: 'final', start: '2025-01-09', end: '2025-01-12', percent: '50', deps: 'Outline'},
        ];
        sample.forEach(row => add(row));
        draw();
      });
    };

    function draw() {
      if (!ready) return;
      const rows = [...document.querySelectorAll('#tbl tr:not(:first-child)')];
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'ID');
      data.addColumn('string', 'Name');
      data.addColumn('string', 'Resource');
      data.addColumn('date', 'Start');
      data.addColumn('date', 'End');
      data.addColumn('number', 'Duration');
      data.addColumn('number', 'Percent');
      data.addColumn('string', 'Dependencies');
      data.addRows(rows.map(r => {
        const c = r.cells;
        return [
          c[0].children[0].value,
          c[1].children[0].value || c[0].children[0].value,
          c[2].children[0].value || null,
          new Date(c[3].children[0].value),
          new Date(c[4].children[0].value),
          +c[5].children[0].value || 0,
          +c[6].children[0].value || 0,
          c[7].children[0].value || null
        ];
      }));
      
      chart.draw(data, {height: (rows.length * 45 + 45)});
      window.onresize = draw;
    }

    function add(v = {}) {
      const tr = document.getElementById('tbl').insertRow();
      ['id','name','resource','start','end','duration','percent','deps'].forEach(k => {
        const td = tr.insertCell();
        const inp = document.createElement('input');
        inp.type = k.includes('start') || k.includes('end') ? 'date' : (k.includes('percent') ? 'number' : 'text');
        inp.value = v[k] || '';
        inp.oninput = draw;
        td.appendChild(inp);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Ã—';
      btn.classList.add('btn');
      btn.onclick = () => { tr.remove(); draw(); };
      tr.insertCell().appendChild(btn);
    }

    document.getElementById('import').onchange = e => {
      const file = e.target.files[0];
      document.querySelector('.file-name-display').textContent = file?.name;
      document.title = file?.name;
      if (!file) return;
      file.text().then(text => {
        document.querySelectorAll('#tbl tr:not(:first-child)').forEach(r => r.remove());
        text.split('\n').slice(1).forEach(line => {
          const parts = [];
          let current = '', inQuotes = false;
          for (let char of line) {
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { parts.push(current.trim()); current = ''; }
            else current += char;
          }
          parts.push(current.trim());
          const [id, name, resource, start, end, duration, percent, deps] = parts;
          if (id) add({id, name, resource, start, end, duration, percent, deps});
        });
        draw();
      });
    };

    function exp() {
      const rows = [...document.querySelectorAll('#tbl tr:not(:first-child)')];
      const csv = 'id,name,resource,start,end,duration,percent,deps\n' + rows.map(r => 
        [...r.querySelectorAll('input')].map(i => {
          const v = i.value;
          return v.includes(',') ? `"${v}"` : v;
        }).join(',')
      ).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv]));
      a.download = 'gantt.csv';
      a.click();
    }
  </script>
</body>
</html>