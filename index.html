<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gantt Chart</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    table { border-collapse: collapse; margin: 12px 0; }
    th, td { padding: 4px 8px; border: 1px solid #ddd; }
    input { width: 100%; box-sizing: border-box; }
    button { margin: 4px; }
  </style>
</head>
<body>
  <input type="file" id="import" accept=".csv">
  <div id="chart" style="max-height:600px"></div>
  <button onclick="add()">Add row</button>
  <button onclick="exp()">Export</button>
  <table id="tbl">
    <tr><th>ID<th>Name<th>Category<th>Start<th>End<th>Duration<th>%<th>Deps<th>
  </table>

  <script>
    let chart, ready = false;
    
    window.onload = () => {
      google.charts.load('current', {packages: ['gantt']});
      google.charts.setOnLoadCallback(() => {
        chart = new google.visualization.Gantt(document.getElementById('chart'));
        ready = true;
      });
    };

    function draw() {
      if (!ready) return;
      const rows = [...document.querySelectorAll('#tbl tr:not(:first-child)')];
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'ID');
      data.addColumn('string', 'Name');
      data.addColumn('string', 'Resource');
      data.addColumn('date', 'Start');
      data.addColumn('date', 'End');
      data.addColumn('number', 'Duration');
      data.addColumn('number', 'Percent');
      data.addColumn('string', 'Dependencies');
      
      data.addRows(rows.map(r => {
        const c = r.cells;
        return [
          c[0].children[0].value,
          c[1].children[0].value || c[0].children[0].value,
          c[2].children[0].value || null,
          new Date(c[3].children[0].value),
          new Date(c[4].children[0].value),
          +c[5].children[0].value || 0,
          +c[6].children[0].value || 0,
          c[7].children[0].value || null
        ];
      }));
      
      chart.draw(data, {height: 600});
    }

    function add(v = {}) {
      const tr = document.getElementById('tbl').insertRow();
      ['id','name','resource','start','end','duration','percent','deps'].forEach(k => {
        const td = tr.insertCell();
        const inp = document.createElement('input');
        inp.type = k.includes('start') || k.includes('end') ? 'date' : (k.includes('percent') ? 'number' : 'text');
        inp.value = v[k] || '';
        inp.oninput = draw;
        td.appendChild(inp);
      });
      const btn = document.createElement('button');
      btn.textContent = 'Ã—';
      btn.onclick = () => { tr.remove(); draw(); };
      tr.insertCell().appendChild(btn);
    }

    document.getElementById('import').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      file.text().then(text => {
        document.querySelectorAll('#tbl tr:not(:first-child)').forEach(r => r.remove());
        text.split('\n').slice(1).forEach(line => {
          const parts = [];
          let current = '', inQuotes = false;
          for (let char of line) {
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { parts.push(current.trim()); current = ''; }
            else current += char;
          }
          parts.push(current.trim());
          const [id, name, resource, start, end, duration, percent, deps] = parts;
          if (id) add({id, name, resource, start, end, duration, percent, deps});
        });
        draw();
      });
    };

    function exp() {
      const rows = [...document.querySelectorAll('#tbl tr:not(:first-child)')];
      const csv = 'id,name,resource,start,end,duration,percent,deps\n' + rows.map(r => 
        [...r.querySelectorAll('input')].map(i => {
          const v = i.value;
          return v.includes(',') ? `"${v}"` : v;
        }).join(',')
      ).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv]));
      a.download = 'gantt.csv';
      a.click();
    }
  </script>
</body>
</html>